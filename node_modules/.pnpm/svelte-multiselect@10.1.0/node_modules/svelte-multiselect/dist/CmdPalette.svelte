<script>import { tick } from 'svelte';
import { fade } from 'svelte/transition';
import Select from './MultiSelect.svelte';
export let actions;
export let triggers = [`k`];
export let close_keys = [`Escape`];
export let fade_duration = 200; // in ms
export let style = ``; // for dialog
// for span in option slot, has no effect when passing a slot
export let span_style = ``;
export let open = false;
export let dialog = null;
export let input = null;
export let placeholder = `Filter actions...`;
async function toggle(event) {
    if (triggers.includes(event.key) && event.metaKey && !open) {
        // open on cmd+trigger
        open = true;
        await tick(); // wait for dialog to open and input to be mounted
        input?.focus();
    }
    else if (close_keys.includes(event.key) && open) {
        open = false;
    }
}
function close_if_outside(event) {
    if (open && !dialog?.contains(event.target)) {
        open = false;
    }
}
function run_and_close(event) {
    event.detail.option.action();
    open = false;
}
</script>

<svelte:window on:keydown={toggle} on:click={close_if_outside} />

{#if open}
  <dialog open bind:this={dialog} transition:fade={{ duration: fade_duration }} {style}>
    <Select
      options={actions}
      bind:input
      {placeholder}
      on:add={run_and_close}
      on:keydown={toggle}
      {...$$restProps}
      let:option
    >
      <!-- wait for https://github.com/sveltejs/svelte/pull/8304 -->
      <slot>
        <span style={span_style}>{option.label}</span>
      </slot>
    </Select>
  </dialog>
{/if}

<style>
  :where(dialog) {
    position: fixed;
    top: 30%;
    border: none;
    padding: 0;
    background-color: transparent;
    display: flex;
    color: white;
    z-index: 10;
    font-size: 2.4ex;
  }
  dialog :global(div.multiselect) {
    --sms-bg: var(--sms-options-bg);
    --sms-width: min(20em, 90vw);
    --sms-max-width: none;
    --sms-placeholder-color: lightgray;
    --sms-options-margin: 1px 0;
    --sms-options-border-radius: 0 0 1ex 1ex;
  }
</style>
